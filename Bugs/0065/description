Number: 0065
Title:       Translation to RTL fails.
Keywords:    RTL, record projection
Submitter:   David Swasey <swasey@cs.cmu.edu>
Date:        11/16/01
Version:     CVS
System:	     any
Severity:    major
Problem:
	The compiler fails while translating the following code to
	RTL.  While isolating the bug, the actual error reported
	changed.  See the transcript for both errors.
		(*$import *)

		signature RTL =
		sig
		  datatype label = ML_EXTERN_LABEL
		  datatype sregi = THREADPTR
		  datatype regi = REGI
		  datatype rep_path = Projvar_p
		  datatype rep = COMPUTE
		  datatype regf = REGF
		  datatype reg = I
		  datatype ea = REA
		  datatype cmp = EQ
		end

		functor Bug (structure Rtl : RTL) =
		struct
		  fun cmpf2s (Rtl.EQ) = "eq"
		  fun cmpi2s c signflag = (cmpf2s c)
		end
Code:
	tilt mapfile-bug
Transcript:
	Current error:
		===== Translating to RTL             =====
		tilt: tortl-base.sml: Record too big

	Original error:
		===== Starting ClosureConv: Pprtl                        =====
		===== Translating to RTL             =====

		================================================
		Starting translation to TIL-Alpha assembly
		  42 procedures.  42 recursive components.   Largest component has size 1.
		tilt: tracetable.sml: index too large
Comments:
	The problem is that some projection code generated by RtlBase
	works only for records which contain no more than
	Rtltags.maxRecordLength (currently 24) elements.  The nine
	datatypes above lead to a projection from a record with 27
	elements (an in-coercion, out-coercion, and equality function
	for each type), which tickles the bug.  The bug is not
	specific to the opaque interpretation; for example,
	transparent-bug.sml fails to compile under the old compiler.
Fix:
	TortlBase was made aware of the representation of large
	records.  Specifically, maxRtlRecord and record_project were
	moved from TortlRecord to TortlBase and repPathIsPointer was
	modified to use record_project rather than the limited
	projection code it had been using.  (This fix was suggested by
	the comment "should be using record_project" in
	repPathIsPointer.)
Test:
Owner: swasey
Status: closed
