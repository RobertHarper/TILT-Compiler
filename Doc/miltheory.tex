\documentclass{article}
\usepackage{theorem,code,latexsym,fullpage,fleqn}
\include{lambda}

\title{Typechecking a Simplified MIL}

%\author{Chris Stone \and Perry Cheng \and Bob Harper}

%\setlength{\abovedisplayskip}{0ptplus4pt}
%\setlength{\belowdisplayskip}{0ptplus4pt}
%\setlength{\abovedisplayshortskip}{0ptplus4pt}
%\setlength{\belowdisplayshortskip}{0ptplus4pt}

\theoremstyle{break}
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newcommand{\qed}{\mbox{QED}}
\newcommand{\dom}{\mathop{\mathrm{dom}}}
\newcommand{\env}{\gamma}
\newcommand{\equivcontext}[2]{\vdash #1 \equiv #2}

\raggedright


\newenvironment{proof}{\noindent{\bf Proof:}\hspace*{0.5em}}{\hspace*{\fill}\qed}

\begin{document}

\maketitle

\section{Simplified MIL}

\subsection{Abstract Syntax}

\renewcommand{\ksingleton}[1]{S(#1)}
\renewcommand{\cfunction}[3]{\lambda #1{:}#2.#3}
\newcommand{\cpi}[2]{{\pi_{#1}}{#2}}
\newcommand{\cpair}[2]{\langle{#1},{#2}\rangle}
\renewcommand{\kind}{A}
\newcommand{\otherkind}{B}
\renewcommand{\cvar}{x}
\newcommand{\othercvar}{y}
\renewcommand{\constructor}{M}
\newcommand{\otherconstructor}{N}
\renewcommand{\substitute}[2]{\{#1{\mapsto}#2\}}


\[
\begin{array}{rll}
\kind ::= &\ktype&\mbox{kind of types}\\
    |&\ksingleton{\constructor}&\mbox{singleton kind}\\
    |&\kpi{\cvar}{\kind_1}{\kind_2}&\mbox{function kind}\\
    |&\ksigma{\cvar}{\kind_1}{\kind_2}&\mbox{dependent pair kind}\\[7pt]

\constructor ::= &\basetype&\mbox{base type}\\
    |&\cvar&\mbox{constructor variable}\\
    |&\cfunction{\cvar}{\kind}{\constructor}
         &\mbox{constructor function}\\
    |&\capply{\constructor}{\constructor'}&\mbox{constructor application}\\
    |&\cpair{\constructor}{\constructor'}&\mbox{constructor pair}\\
    |&\cpi{i}{\constructor}&\mbox{constructor projection}\\
\end{array}
\]

\subsection{Static Semantics}

\sectionrule{Well-Formed Context}{\validcontext{\context}}

\infrule
  {}
  {\validcontext{\emptycontext}}

\labelledinfrule
  {wfctx:extend}
  {\validkind{\context}{\kind}\qquad
     \cvar\not\in\BV{\context}}
  {\validcontext{\emptycontext,\sbindconstructor{\cvar}{\kind}}}


\sectionrule{Well-Formed Kind}{\validkind{\context}{\kind}}

\labelledinfrule
  {wfk:ktype}
  {\validcontext{\context}}
  {\validkind{\context}{\ktype}}

\labelledinfrule
  {wfk:ksingleton}
  {\validconstructor{\context}{\constructor}{\ktype}}
  {\validkind{\context}{\ksingleton{\constructor}}}

\labelledinfrule
  {wfk:kpi}
  {\validkind{\context}{\kind_1}\qquad
   \validkind{\context,\sbindconstructor{\cvar}{\kind_1}}{\kind_2}}
  {\validkind{\context}{\kpi{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {wfk:ksigma}
  {\validkind{\context}{\kind_1}\qquad
   \validkind{\context,\sbindconstructor{\cvar}{\kind_1}}{\kind_2}}
  {\validkind{\context}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}

\sectionrule{Subkinding}{\subkind{\context}{\kind}{\kind'}}

\labelledinfrule
  {sk:ktype}
  {\validcontext{\context}}
  {\subkind{\context}{\ktype}{\ktype}}

\labelledinfrule
  {sk:ksingleton}
  {\equivconstructor{\context}{\constructor_1}{\constructor_2}{\ktype}}
  {\subkind{\context}{\ksingleton{\constructor_1}}
     {\ksingleton{\constructor_2}}}


\labelledinfrule
  {sk:forget}
  {\validkind{\context}{\ksingleton{\constructor}}}
  {\subkind{\context}{\ksingleton{\constructor}}{\ktype}}

\labelledinfrule
  {sk:pi}
  {\subkind{\context}{\kind'_1}{\kind_1}\qquad
      \subkind{\context,\sbindconstructor{\cvar}{\kind'_1}}
                {\kind_2}{\kind'_2}}
  {\subkind{\context}
      {\kpi{\cvar}{\kind_1}{\kind_2}}
      {\kpi{\cvar}{\kind'_1}{\kind'_2}}}

\infrule
  {\subkind{\context}{\kind_1}{\kind'_1}\quad
   \subkind{\context,\sbindconstructor{\cvar}{\kind_1}}
        {\kind_2}{\kind'_2}}
  {\subkind{\context}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}
     {\ksigma{\cvar}{\kind'_1}{\kind'_2}}}

\sectionrule{Well-Formed Constructor}
   {\validconstructor{\context}{\constructor}{\kind}}

\labelledinfrule
  {wfc:basetype}
  {\validcontext{\context}}
  {\validconstructor{\context}{\basetype}{\ktype}}

\labelledinfrule
  {wfc:cvar}
  {\validcontext{\context}}
  {\validconstructor{\context}{\cvar}{\context(\cvar)}}

\labelledinfrule
  {wfc:cfunction}
  {\validconstructor{\context,\sbindconstructor{\cvar}{\kind_1}}
          {\constructor}{\kind_2}}
  {\validconstructor{\context}
     {\cfunction{\cvar}{\kind_1}{\constructor}}
     {\kpi{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {wfc:capply}
  {\validconstructor{\context}{\constructor}{\kpi{\cvar}{\kind_1}{\kind_2}}
   \qquad
   \validconstructor{\context}{\constructor_1}{\kind_1}}
  {\validconstructor{\context}{\capply{\constructor}{\constructor_1}}
      {\substitute{\cvar}{\constructor_1}{\kind_2}}}

\labelledinfrule
  {wfc:cpione}
  {\validconstructor{\context}{\constructor}{\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\validconstructor{\context}{\cpi{1}{\constructor}}{\kind_1}}

\labelledinfrule
  {wfc:cpitwo}
  {\validconstructor{\context}{\constructor}{\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\validconstructor{\context}{\cpi{2}{\constructor}}
          {\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2}}}

\labelledinfrule
  {wfc:cpair}
  {\validconstructor{\context}{\constructor_1}{\kind_1}\qquad
   \validkind{\context,\cvar{:}\kind_1}{\kind_2}\qquad
   \validconstructor{\context}{\constructor_2}
    {\substitute{\cvar}{\constructor_1}{\kind_2}}}
  {\validconstructor{\context}{\cpair{\constructor_1}{\constructor_2}}
      {\ksigma{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {wfc:forgetsingleton}
  {\validconstructor{\context}{\constructor}{\ktype}}
  {\validconstructor{\context}{\constructor}{\ksingleton{\constructor}}}

\labelledinfrule
  {wfc:selfsigmaone}
  {\validconstructor{\context}{\constructor}
                       {\ksigma{\cvar}{\kind_1}{\kind_2}}\qquad
      \validconstructor{\context}{\cpi{1}{\constructor}}{\kind'_1}}
  {\validconstructor{\context}{\constructor}
                       {\ksigma{\cvar}{\kind'_1}{\kind_2}}}

\labelledinfrule
  {wfc:selfsigmatwo}
  {\validconstructor{\context}{\constructor}
                       {\ksigma{\cvar}{\kind_1}{\kind_2}}\qquad
      \validconstructor{\context}{\cpi{2}{\constructor}}{\kind'_2}}
  {\validconstructor{\context}{\constructor}
                       {\ksigma{\cvar}{\kind_1}{\kind'_2}}}

\labelledinfrule
  {wfc:selfpi}
  {\validconstructor{\context}{\constructor}
                       {\kpi{\cvar}{\kind_1}{\kind_2}}\qquad
      \validconstructor{\context,\cvar{:}\kind_1}
                       {\capply{\constructor}{\cvar}}{\kind'_2}}
  {\validconstructor{\context}{\constructor}
                       {\kpi{\cvar}{\kind_1}{\kind'_2}}}

\labelledinfrule
  {wfc:subsume}
  {\validconstructor{\context}{\constructor}{\kind}\qquad
     \subkind{\context}{\kind}{\kind'}}
  {\validconstructor{\context}{\constructor}{\kind'}}

\sectionrule{Constructor Equivalence}
  {\equivconstructor{\context}{\constructor}{\constructor'}{\kind}}

\labelledinfrule
  {ce:reflexive}
  {\validconstructor{\context}{\constructor}{\kind}}
  {\equivconstructor{\context}{\constructor}{\constructor}{\kind}}

\labelledinfrule
  {ce:symmetric}
  {\equivconstructor{\context}{\constructor'}{\constructor}{\kind}}
  {\equivconstructor{\context}{\constructor}{\constructor'}{\kind}}

\labelledinfrule
  {ce:transitive}
  {\equivconstructor{\context}{\constructor}{\constructor'}{\kind}\qquad
   \equivconstructor{\context}{\constructor'}{\constructor''}{\kind}}
  {\equivconstructor{\context}{\constructor}{\constructor''}{\kind}}

\labelledinfrule
  {ce:singleton}
  {\validconstructor{\context}{\constructor}
     {\ksingleton{\constructor'}}}
  {\equivconstructor{\context}{\constructor}{\constructor'}{\ktype}}

\labelledinfrule
  {ce:cfunction}
  {\equivconstructor{\context,\sbindconstructor{\cvar}{\kind_1}}
     {\constructor}{\constructor'}{\kind_2}}
  {\equivconstructor{\context}
     {\cfunction{\cvar}{\kind_1}{\constructor}}
     {\cfunction{\cvar}{\kind_1}{\constructor'}}
     {\kpi{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {ce:cpione}
  {\equivconstructor{\context}{\constructor}{\constructor'}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\cpi{1}{\constructor}}{\cpi{1}{\constructor'}}{\kind_1}}

\labelledinfrule
  {ce:cpitwo}
  {\equivconstructor{\context}{\constructor}{\constructor'}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\cpi{2}{\constructor}}{\cpi{2}{\constructor'}}
     {\substitute{\cvar}{\cpi{1}{\constructor}}\kind_2}}

\labelledinfrule
  {ce:cpair}
  {\equivconstructor{\context}{\constructor_1}{\constructor'_1}{\kind_1}\qquad
   \equivconstructor{\context}{\constructor_2}{\constructor'_2}
       {\substitute{\cvar}{\constructor_1}\kind_2}}
  {\equivconstructor{\context}
     {\cpair{\constructor_1}{\constructor_2}}
     {\cpair{\constructor'_1}{\constructor'_2}}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {ce:capply}
  {\equivconstructor{\context}{\constructor}{\constructor'}
                    {\kpi{\cvar}{\kind_1}{\kind_2}}\qquad
   \equivconstructor{\context}
                    {\constructor_1}{\constructor'_1}{\kind_1}}
  {\equivconstructor{\context}
     {\capply{\constructor}{\constructor_1}}
     {\capply{\constructor'}{\constructor'_1}}
     {\substitute{\cvar}{\constructor_1}{\kind_2}}}

\labelledinfrule
  {ce:cfunctioneta}
  {\validconstructor{\context}{\constructor}
     {\kpi{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\cfunction{\cvar}{\kind_1}{(\capply{\constructor}{\cvar})}}
     {\constructor}{\kpi{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {ce:cfunctionbeta}
  {\validconstructor{\context}
     {\cfunction{\cvar}{\kind_2}{\constructor}}
     {\kpi{\cvar}{\kind_2}{\kind}}\qquad
   \validconstructor{\context}{\constructor_2}{\kind_2}}
  {\equivconstructor{\context}
     {\capply{(\cfunction{\cvar}{\kind_2}{\constructor})}
             {\constructor_2}}
     {\substitute{\cvar}{\constructor_2}{\constructor}}
     {\substitute{\cvar}{\constructor_2}{\kind}}}

\labelledinfrule
  {ce:cpionebeta}
  {\validconstructor{\context}{\cpair{\constructor_1}{\constructor_2}}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\cpi{1}{\cpair{\constructor_1}{\constructor_2}}}
     {\constructor_1}{\kind_1}}

\labelledinfrule
  {ce:cpitwobeta}
  {\validconstructor{\context}{\cpair{\constructor_1}{\constructor_2}}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\cpi{2}{\cpair{\constructor_1}{\constructor_2}}}
     {\constructor_2}{\substitute{\cvar}{\constructor_1}{\kind_2}}}

\labelledinfrule
  {ce:cpaireta}
  {\validconstructor{\context}{\constructor}{\ksigma{\cvar}{\kind_1}{\kind_2}}}
  {\equivconstructor{\context}
     {\constructor}
     {\cpair{\cpi{1}{\constructor}}{\cpi{2}{\constructor}}}
     {\ksigma{\cvar}{\kind_1}{\kind_2}}}

\labelledinfrule
  {ce:subsume}
  {\equivconstructor{\context}{\constructor_1}{\constructor_2}{\kind}
   \qquad
   \subkind{\context}{\kind}{\kind'}}
  {\equivconstructor{\context}{\constructor_1}{\constructor_2}{\kind'}}

\section{Algorithm for Constructor Equivalence}

\subsection{Elimination Contexts}

\newcommand{\hole}{\bullet}

\[
\begin{array}{rll}
E ::= &\hole\\
    |&\capply{E}{\constructor}\\
    |&\cpi{1}{E}\\
    |&\cpi{2}{E}\\
\end{array}
\]

\subsection{Equivalence algorithm}

\newcommand{\weakconequiv}[4]{#1\vdash #2 \sim #3 : #4}
\newcommand{\conequiv}[4]{#1\vdash #2 \Join #3 : #4}
\newcommand{\aconequiv}[4]{#1\vdash #2 \iff #3 : #4}
\newcommand{\akindequiv}[3]{#1\vdash #2 \iff #3}
\newcommand{\headnormsto}[4]{#1\vdash #2 \Downarrow #4}
\newcommand{\reconstruct}[3]{#1\vdash #2 \Uparrow #3}
\newcommand{\isvalue}[3]{#1\vdash #2\mbox{\ value } #3}
\newcommand{\cvalue}{V}
\[
\!\!\!\!\!\!\!\begin{array}{lp{4.2truein}}
\headnormsto{\context}
   {E[\capply{(\cfunction{\cvar}{\kind}{\constructor})}
             {\constructor'}]}
   {\ktype}
   {\cvalue}&
   if 
   $\headnormsto{\context}
     {E[\substitute{\cvar}{\constructor'}{\constructor}]}{\ktype}{\cvalue}$\\

\headnormsto{\context}
   {E[\cpi{1}{\cpair{\constructor_1}{\constructor_2}}]}
   {\ktype}
   {\cvalue}&
   if
   $\headnormsto{\context}{E[\constructor_1]}{\ktype}{\cvalue}$\\
\headnormsto{\context}
   {E[\cpi{2}{\cpair{\constructor_1}{\constructor_2}}]}
   {\ktype}
   {\cvalue}&
   if
   $\headnormsto{\context}{E[\constructor_2]}{\ktype}{\cvalue}$\\
\headnormsto{\context}{E[\cvar]}{\ktype}{\cvalue}&
   if
   $\reconstruct{\context}{E[\cvar]}{\ksingleton{\constructor}}$ and
   $\headnormsto{\context}{\constructor}{\ktype}{\cvalue}$\\
\headnormsto{\context}{\cvalue}{\ktype}{\cvalue}\\[7pt]

\reconstruct{\context}{\cvar}{\context(\cvar)}\\
\reconstruct{\context}{\cpi{1}{E[\cvar]}}{\kind_1}&
  if
  $\reconstruct{\context}{E[\cvar]}{\ksigma{\othercvar}{\kind_1}{\kind_2}}$\\
\reconstruct{\context}{\cpi{2}{E[\cvar]}}
  {\substitute{\othercvar}{\cpi{1}{E[\cvar]}}\kind_2}&
  if
  $\reconstruct{\context}{E[\cvar]}{\ksigma{\othercvar}{\kind_1}{\kind_2}}$\\
\reconstruct{\context}{\capply{E[\cvar]}{\constructor}}
  {\substitute{\othercvar}{\constructor}{\kind_2}}&
  if
  $\reconstruct{\context}{E[\cvar]}{\kpi{\othercvar}{\kind_1}{\kind_2}}$\\[7pt]

\aconequiv{\context}{\constructor}{\constructor'}{\ktype}&
  if
    $\headnormsto{\context}{\constructor}{\kind}{\cvalue}$,
    $\headnormsto{\context}{\constructor'}{\kind}{\cvalue'}$, 
    $\weakconequiv{\context}{\cvalue}{\cvalue'}{\ktype}$, and
    $\weakconequiv{\context}{\cvalue'}{\cvalue}{\ktype}$\\
\aconequiv{\context}{\constructor}{\constructor'}{\ksingleton{\constructor''}}&
  always\\
\aconequiv{\context}{\constructor}{\constructor'}
  {\kpi{\cvar}{\kind}{\kind'}}&
  if
  $\aconequiv{\context,\cvar{:}\kind}{\capply{\constructor}{\cvar}}
           {\capply{\constructor'}{\cvar}}{\kind'}$\\ %$
\aconequiv{\context}{\constructor}{\constructor'}
  {\ksigma{\cvar}{\kind_1}{\kind_2}}&
  if
  $\aconequiv{\context}{\cpi{1}{\constructor}}
     {\cpi{1}{\constructor'}}{\kind_1}$, %$
  $\aconequiv{\context}{\cpi{2}{\constructor}}
           {\cpi{2}{\constructor'}}
           {\substitute{\cvar}{\cpi{1}{\constructor}}\kind_2}$, and
  $\aconequiv{\context}{\cpi{2}{\constructor}}
           {\cpi{2}{\constructor'}}
           {\substitute{\cvar}{\cpi{1}{\constructor'}}\kind_2}$\\[7pt]

\weakconequiv{\context}{\basetype}{\basetype}{\kind}&
  if $\kind=\ktype$\\
\weakconequiv{\context}{\othercvar}{\othercvar}{\kind}&
  if $\kind=\context(\cvar)$\\
\weakconequiv{\context}{\capply{(E_1[\othercvar])}{\constructor_1}}
  {\capply{(E_2[\othercvar])}{\constructor_2}}{\kind}&
  if 
  $\weakconequiv{\context}{E_1[\othercvar]}{E_2[\othercvar]}
    {\kpi{\cvar}{\kind_1}{\kind_2}}$,
  andalso
  $\aconequiv{\context}{\constructor_1}{\constructor_2}{\kind_1}$ and
  $\kind = \substitute{\cvar}{\constructor_1}{\kind_2}$\\
\weakconequiv{\context}{\cpi{1}{(E_1[\othercvar])}}
  {\cpi{1}{(E_2[\othercvar])}}{\kind}&
  if $\weakconequiv{\context}{E_1[\othercvar]}{E_2[\othercvar]}
    {\ksigma{\cvar}{\kind_1}{\kind_2}}$,
  and
  $\kind = \kind_1$\\
\weakconequiv{\context}{\cpi{2}{(E_1[\othercvar])}}
  {\cpi{2}{(E_2[\othercvar])}}{\kind}&
  if $\weakconequiv{\context}{E_1[\othercvar]}{E_2[\othercvar]}
    {\ksigma{\cvar}{\kind_1}{\kind_2}}$,
  and
  $\kind = \substitute{\cvar}{\cpi{1}{(E_1[\othercvar])}}{\kind_2}$\\[7pt]

\akindequiv{\context}{\ktype}{\ktype}&always\\
\akindequiv{\context}{\ksingleton{\constructor_1}}
   {\ksingleton{\constructor_2}}&
  if $\aconequiv{\context}{\constructor_1}{\constructor_2}{\ktype}$\\
\akindequiv{\context}{\kpi{\cvar}{\kind_1}{\otherkind_1}} 
   {\kpi{\cvar}{\kind_2}{\otherkind_2}}&
  if $\akindequiv{\context}{\kind_1}{\kind_2}$ and
  $\akindequiv{\context,\cvar{:}\kind_1}{\otherkind_1}{\otherkind_2}$\\
\akindequiv{\context}{\ksigma{\cvar}{\kind_1}{\otherkind_1}} 
   {\ksigma{\cvar}{\kind_2}{\otherkind_2}}&
  if $\akindequiv{\context}{\kind_1}{\kind_2}$ and
  $\akindequiv{\context,\cvar{:}\kind_1}{\otherkind_1}{\otherkind_2}$\\
\end{array}
\]

\section{Correctness}

\newcommand{\semanticvalidtype}[2]{{#2}\mathrm{\ type\ }[#1]}
\newcommand{\semanticequivtype}[3]{{#2}\mathrm{\ is\ }{#3}\ [#1]}
\newcommand{\semanticsubtype}[3]{{#2}\mathrm{\ sub\ }{#3}\ [#1]}
\newcommand{\semanticvalidterm}[3]{{#2}\mathrm{\ in\ }{#3}\ [#1]}
\newcommand{\semanticequivterm}[4]{{#2}\mathrm{\ is\ }{#3}\mathrm{\ in\ }{#4}\ [#1]}
\newcommand{\world}{\Delta}
\newcommand{\semanticcontext}[1]{{#1}\,\mbox{ctxt}}
\newcommand{\normterm}[3]{{#1}\vdash{#2}\mbox{\ norm\ }{#3}}
\newcommand{\normtype}[2]{{#1}\vdash{#2}\mbox{\ norm}}
\newcommand{\bisim}[4]{{#1}\vdash{#2}\mbox{\ bisim\ }{#3} : #4}
\newcommand{\normE}[3]{{#1}\vdash{#2}\mbox{\ norm}^*\ {#3}}
\newcommand{\algorithmicequivterm}[4]{#1\vdash #2 \iff #3 : #4}
\newcommand{\algorithmicequivtype}[3]{#1\vdash #2 \iff #3}
\newcommand{\algorithmicwhnf}{\headnormsto}
\newcommand{\semanticE}[3]{#2\mbox{\ compute\ }#3\ [#1]}

\begin{itemize}


\item
$\semanticcontext{\world}$ iff
%\begin{itemize}{}
%\item $\world = \emptysequence$
%\item Or, $\world = \world',\cvar{:}\kind$ and $\semanticcontext{\world'}$ and
%$\normtype{\world'}{\kind}$.
%\end{itemize}
$\validcontext{\world}$.

\item
$\semanticvalidtype{\world}{\kind}$ iff
\begin{enumerate}
\item $\semanticcontext{\world}$
\item $\validkind{\world}{\kind}$
\item
\begin{itemize}{}
\item $\kind = \ktype$
\item Or, $\kind = \ksingleton{\constructor}$ and 
$\normterm{\world}{\constructor}{\ktype}$
\item Or, $\kind = \kpi{\evar}{\kind_1}{\kind_2}$ and
$\semanticvalidtype{\world}{\kind_1}$ and
$\forall \world'\supseteq\world$ if $\semanticvalidterm{\world'}{\constructor}{\kind_1}$
then $\semanticvalidtype{\world'}{\substitute{\cvar}{\constructor}{\kind_2}}$ and
if $\semanticequivterm{\world'}{\constructor}{\constructor'}{\kind_1}$ then
$\semanticsubtype{\world'}{\substitute{\cvar}{\constructor}{\kind_2}}{\substitute{\cvar}{\constructor'}{\kind_2}}$
(and by symmetry
$\semanticsubtype{\world'}{\substitute{\cvar}{\constructor'}{\kind_2}}{\substitute{\cvar}{\constructor}{\kind_2}}$).
\item Or, $\kind = \ksigma{\evar}{\kind_1}{\kind_2}$ and
$\semanticvalidtype{\world}{\kind_1}$ and
$\forall \world'\supseteq\world$ if $\semanticvalidterm{\world'}{\constructor}{\kind_1}$
then $\semanticvalidtype{\world'}{\substitute{\cvar}{\constructor}{\kind_2}}$ and
if $\semanticequivterm{\world'}{\constructor}{\constructor'}{\kind_1}$ then
$\semanticsubtype{\world'}{\substitute{\cvar}{\constructor}{\kind_2}}{\substitute{\cvar}{\constructor'}{\kind_2}}$
(and by symmetry
$\semanticsubtype{\world'}{\substitute{\cvar}{\constructor'}{\kind_2}}{\substitute{\cvar}{\constructor}{\kind_2}}$).
\end{itemize}
\end{enumerate}

\item $\semanticsubtype{\world}{\kind_1}{\kind_2}$ iff
\begin{enumerate}
\item $\semanticcontext{\world}$
\item $\subkind{\world}{\kind_1}{\kind_2}$
\item $\forall \constructor$: $\semanticvalidterm{\world}{\constructor}{\kind_1}$ implies
$\semanticvalidterm{\world}{\constructor}{\kind_2}$
\item $\forall \constructor,\constructor'$: 
$\semanticequivterm{\world}{\constructor}{\constructor'}{\kind_1}$ implies
$\semanticequivterm{\world}{\constructor}{\constructor'}{\kind_2}$.
\end{enumerate}

\item $\semanticvalidterm{\world}{\constructor}{\kind}$ iff
\begin{enumerate}
\item $\semanticcontext{\world}$
\item $\semanticvalidtype{\world}{\kind}$
\item $\validconstructor{\world}{\constructor}{\kind}$
\item 
\begin{itemize}{}
\item $\kind = \ktype$ and $\normterm{\world}{\constructor}{\ktype}$
\item Or, $\kind = \ksingleton{\constructor'}$,
$\aconequiv{\world}{\constructor}{\constructor'}{\ktype}$,
%$\aconequiv{\world}{\constructor'}{\constructor}{\ktype}$,
$\normterm{\world}{\constructor}{\ktype}$ and $\normterm{\world}{\constructor'}{\ktype}$.
\item Or, $\kind = \kpi{\cvar}{\kind_1}{\kind_2}$ and
$\forall \world'\supseteq\world$ if $\semanticvalidterm{\world'}{\constructor'}{\kind_1}$
then $\semanticvalidterm{\world'}{\capply{\constructor}{\constructor'}}{\substitute{\cvar}{\constructor'}{\kind_2}}$ and
if $\semanticequivterm{\world'}{\constructor'}{\constructor''}{\kind_1}$ then
$\semanticequivterm{\world'}{\capply{\constructor}{\constructor'}}{\capply{\constructor}{\constructor''}}{\substitute{\cvar}{\constructor'}{\kind_2}}$
(and therefore 
$\semanticequivterm{\world'}{\capply{\constructor}{\constructor'}}{\capply{\constructor}{\constructor''}}{\substitute{\cvar}{\constructor''}{\kind_2}}$).
\item Or, $\kind = \ksigma{\cvar}{\kind_1}{\kind_2}$ and
$\semanticvalidterm{\world}{\cpi{1}{\constructor}}{\kind_1}$ and
$\semanticvalidterm{\world}{\cpi{2}{\constructor}}{\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2}}$.
\end{itemize}
\end{enumerate}

\item $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\kind}$ iff
\begin{enumerate}
\item $\semanticcontext{\world}$
\item $\semanticvalidtype{\world}{\kind}$
\item $\semanticvalidterm{\world}{\constructor_1}{\kind}$
\item $\semanticvalidterm{\world}{\constructor_2}{\kind}$
\item $\equivconstructor{\world}{\constructor_1}{\constructor_2}{\kind}$
\item
\begin{itemize}{}
\item $\kind = \ktype$ and 
$\aconequiv{\world}{\constructor_1}{\constructor_2}{\ktype}$.
\item Or, $\kind = \ksingleton{\constructor''}$ and 
$\aconequiv{\world}{\constructor_1}{\constructor_2}{\ktype}$.
\item Or, $\kind = \kpi{\cvar}{\kind_1}{\kind_2}$ and
$\forall \world'\supseteq\world$ if $\semanticvalidterm{\world'}{\constructor}{\kind_1}$
then $\semanticequivterm{\world'}{\capply{\constructor_1}{\constructor}}{\capply{\constructor_2}{\constructor}}{\substitute{\cvar}{\constructor}{\kind_2}}$.
\item Or, $\kind = \ksigma{\cvar}{\kind_1}{\kind_2}$ and
$\semanticequivterm{\world}{\cpi{1}{\constructor_1}}{\cpi{1}{\constructor_2}}{\kind_1}$ and
$\semanticequivterm{\world}{\cpi{2}{\constructor_1}}{\cpi{2}{\constructor_2}}{\substitute{\cvar}{\cpi{1}{\constructor_1}}{\kind_2}}$
(and hence 
$\semanticequivterm{\world}{\cpi{2}{\constructor_1}}{\cpi{2}{\constructor_2}}{\substitute{\cvar}{\cpi{1}{\constructor_2}}{\kind_2}}$).
\end{itemize}
\end{enumerate}

\item $\normtype{\context}{\kind}$ iff
\begin{enumerate}{}
\item $\validkind{\context}{\kind}$
\item $\akindequiv{\context}{\kind}{\kind}$
\end{enumerate}

\item $\normterm{\context}{\constructor}{\kind}$ iff
\begin{enumerate}
\item $\validconstructor{\context}{\constructor}{\kind}$
\item $\aconequiv{\context}{\constructor}{\constructor}{\kind}$
\end{enumerate}

\item $\normE{\context}{\constructor}{\kind}$ iff
\begin{enumerate}
\item $\validconstructor{\context}{\constructor}{\kind}$
\item $\weakconequiv{\context}{\constructor}{\constructor}{\kind}$
\end{enumerate}

\end{itemize}

\section{Proofs}

\begin{lemma}
\begin{enumerate}
\item
If $\semanticequivterm{\world}{\constructor}{\otherconstructor}{\kind}$ then
$\semanticequivterm{\world}{\otherconstructor}{\constructor}{\kind}$.
\item
If $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\kind}$ and
$\semanticequivterm{\world}{\constructor_2}{\constructor_3}{\kind}$ then
$\semanticequivterm{\world}{\constructor_1}{\constructor_3}{\kind}$.
\end{enumerate}
\end{lemma}

\begin{lemma}
\begin{enumerate}
\item
If $\aconequiv{\world}{\constructor}{\otherconstructor}{\kind}$ then
$\aconequiv{\world}{\otherconstructor}{\constructor}{\kind}$.
\item
If $\aconequiv{\world}{\constructor_1}{\constructor_2}{\kind}$ and
$\aconequiv{\world}{\constructor_2}{\constructor_3}{\kind}$ then
$\aconequiv{\world}{\constructor_1}{\constructor_3}{\kind}$.
\item
If $\akindequiv{\world}{\kind}{\otherkind}$ then
$\akindequiv{\world}{\otherkind}{\kind}$
\item
If $\akindequiv{\world}{\kind_1}{\kind_2}$ and
$\akindequiv{\world}{\kind_2}{\kind_3}$ then
$\akindequiv{\world}{\kind_1}{\kind_3}$.
\end{enumerate}
\end{lemma}

\begin{theorem}
\label{maintheorem}
If $\validkind{\world}{\kind}$ and $\semanticvalidtype{\world}{\kind}$ then
\begin{enumerate}
\item 
\label{ih-1}
$\normtype{\world}{\kind}$
\item
\label{ih-2}
If $\reconstruct{\world}{E[\othercvar]}{\kind}$
and $\normE{\world}{E[\othercvar]}{\kind}$ then
$\semanticvalidterm{\world}{E[\othercvar]}{\kind}$.
\item
\label{ih-3}
If $\reconstruct{\world}{E[\othercvar]}{\kind}$,
$\reconstruct{\world}{E'[\othercvar]}{\kind'}$,
$\equivkind{\world}{\kind}{\kind'}$,
%$\akindequiv{\world}{\kind}{\kind'}$,
$\semanticvalidterm{\world}{E[\othercvar]}{\kind}$,
$\semanticvalidterm{\world}{E'[\othercvar]}{\kind}$,
$\equivconstructor{\world}{E[\othercvar]}{E'[\othercvar]}{\kind}$,
$\weakconequiv{\world}{E[\othercvar]}{E'[\othercvar]}{\kind}$ then
$\semanticequivterm{\world}{E[\othercvar]}{E'[\othercvar]}{\kind}$.
\item
\label{ih-4}
If $\semanticvalidterm{\world}{\constructor}{\kind}$ then
$\normterm{\world}{\constructor}{\kind}$.
\item
\label{ih-5}
If $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\kind}$ then
$\aconequiv{\world}{\constructor_1}{\constructor_2}{\kind}$.
\end{enumerate}
\end{theorem}

\begin{proof}[By induction on $\kind$]
Assume $\validkind{\world}{\kind}$ and $\semanticvalidtype{\world}{\kind}$.
\begin{itemize}
\item Case: $\kind = \ktype$.
\begin{enumerate}
\item $\normtype{\world}{\ktype}$ by definition.
\item $\headnormsto{\world}{E[\othercvar]}{\ktype}{E[\othercvar]}$ because
$\reconstruct{\world}{E[\othercvar]}{\ktype}$.  Thus
$\normE{\world}{E[\othercvar]}{\ktype}$ implies
$\normterm{\world}{E[\othercvar]}{\ktype}$.
Finally, because
$\validkind{\world}{\kind}$ implies $\validcontext{\world}$, we also
have $\validconstructor{\world}{E[\othercvar]}{\ktype}$.  Therefore
$\semanticvalidterm{\world}{E[\othercvar]}{\ktype}$.
\item Since $\equivkind{\world}{\ktype}{\kind'}$, we must have
$\kind' = \ktype$.  Since both terms are thus in weak head-normal form
and $\weakconequiv{\world}{E[\othercvar]}{E'[\othercvar]}{\ktype}$, we
have $\aconequiv{\world}{E[\othercvar]}{E'[\othercvar]}{\ktype}$.
Therefore
$\semanticequivterm{\world}{E[\othercvar]}{E'[\othercvar]}{\ktype}$.
\item Follows directly from the definition of 
$\semanticvalidterm{\world}{\constructor}{\ktype}$.
\item Follows directly from the definition of 
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ktype}$.
\end{enumerate}

\item Case: $\kind=\ksingleton{\otherconstructor}$.
\begin{enumerate}
\item Because $\semanticvalidtype{\world}{\ksingleton{\otherconstructor}}{\kind'}$ we must
have $\kind'=\ksingleton{\otherconstructor'}$.  By 
$\normterm{\world}{\otherconstructor}{\ktype}$ and therefore
$\normtype{\world}{\ksingleton{\otherconstructor}}$.
\item Because $\reconstruct{\world}{E[\othercvar]}{\ksingleton{\otherconstructor}}$, we
know that $\headnormsto{\world}{E[\othercvar]}{\ktype}{\cvalue}$ if
and only if
$\headnormsto{\world}{\otherconstructor}{\ktype}{\cvalue}$, and
furthermore such a $\cvalue$ would be unique.  But because
$\normtype{\world}{\ksingleton{\otherconstructor}}$, we know that
$\otherconstructor$ is normalizing, so this $\cvalue$ exists and
satisfies $\normterm{\world}{\cvalue}{\ktype}$.  This implies
$\normterm{\world}{\otherconstructor}{\ktype}$,
$\normterm{\world}{E[\othercvar]}{\ktype}$,
$\aconequiv{\world}{E[\othercvar]}{\otherconstructor}{\ktype}$, and
therefore $\semanticvalidterm{\world}{E[\othercvar]}{\ksingleton{\otherconstructor}}$.
\item If suffices to show that $E[\othercvar]$ and $E'[\othercvar]$ are
algorithmically equivalent.  This follows by transitivity
and symmetry, since
$\semanticvalidterm{\world}{E[\othercvar]}{\ksingleton{\otherconstructor}}$ and
$\semanticvalidterm{\world}{E'[\othercvar]}{\ksingleton{\otherconstructor}}$,
imply $\aconequiv{\world}{E[\othercvar]}{\otherconstructor}{\ktype}$ and
$\aconequiv{\world}{E'[\othercvar]}{\otherconstructor}{\ktype}$.
\item Trivial by the definition of 
$\normterm{\world}{\constructor}{\ksingleton{\otherconstructor}}$.
\item Trivial by the definition of 
$\aconequiv{\world}{\constructor_1}{\constructor_2}{\ktype}$.
\end{enumerate}

\item Case: $\kind=\kpi{\cvar}{\kind_1}{\kind_2}$.
\begin{enumerate}
\item 
$\semanticvalidtype{\world}{\kpi{\cvar}{\kind_1}{\kind_2}}$ implies
$\semanticvalidtype{\world}{\kind_1}$.  This further implies that
$\validkind{\world}{\kind_1}$, that $\validcontext{\world,\cvar{:}\kind_1}$, and
by IH(\ref{ih-1}) that $\normtype{\world}{\kind_1}$.
Clearly $\reconstruct{\world,\cvar{:}\kind_1}{\cvar}{\kind_1}$ and 
$\normE{\world,\cvar{:}\kind_1}{\cvar}{\kind_1}$.  By
IH(\ref{ih-2}), $\semanticvalidterm{\world,\cvar{:}\kind_1}{\cvar}{\kind_1}$.
Thus $\semanticvalidtype{\world}{\kind}$ gives us
$\semanticvalidtype{\world,\cvar{:}\kind_1}{\kind_2}$.  By IH(\ref{ih-1}),
$\normtype{\world,\cvar{:}\kind_1}{\kind_2}$.  Therefore
$\normtype{\world}{\kpi{\cvar}{\kind_1}{\kind_2}}$.
\item $\reconstruct{\world}{E[\othercvar]}{\kind}$ implies
$\validconstructor{\world}{E[\othercvar]}{\kind}$.
Let $\world'\supseteq\world$ be given with $\validcontext{\world'}$.
By MONOTONICITY, we have $\reconstruct{\world'}{E[\othercvar]}{\kind}$ and
$\normE{\world'}{E[\othercvar]}{\kind}$.
\begin{itemize}
\item Assume $\semanticvalidterm{\world'}{\constructor}{\kind_1}$.
By IH(\ref{ih-4}) $\normterm{\world'}{\constructor}{\kind_1}$, which
in conjunction with $\normE{\world'}{E[\othercvar]}{\kind}$ yields
$\normE{\world'}{\capply{E[\othercvar]}{\constructor}}{\substitute{\cvar}{\constructor}{\kind_2}}$.
By IH(\ref{ih-2}),
$\semanticvalidterm{\world'}{\capply{(E[\othercvar])}{\constructor}}{\substitute{\cvar}{\constructor}{\kind_2}}$.
\item Assume $\semanticequivterm{\world'}{\constructor_1}{\constructor_2}{\kind_1}$.
By similar arguments, 
$\reconstruct{\world'}{\capply{(E[\othercvar])}{\constructor_1}}{\substitute{\cvar}{\constructor_1}{\kind_2}}$,
$\reconstruct{\world'}{\capply{(E[\othercvar])}{\constructor_2}}{\substitute{\cvar}{\constructor_2}{\kind_2}}$,
$\semanticvalidterm{\world'}{\capply{(E[\othercvar])}{\constructor_1}}{\substitute{\cvar}{\constructor_1}{\kind_2}}$, and
$\semanticvalidterm{\world'}{\capply{(E[\othercvar])}{\constructor_2}}{\substitute{\cvar}{\constructor_2}{\kind_2}}$.
By SUBSTITUTION LEMMA, the equivalence
$\equivconstructor{\world'}{\constructor_1}{\constructor_2}{\kind_1}$ yields
$\equivkind{\world'}{\substitute{\cvar}{\constructor_1}{\kind_2}}{\substitute{\cvar}{\constructor_2}{\kind_2}}$.
By IH(\ref{ih-5}), $\aconequiv{\world'}{\constructor_1}{\constructor_2}{\kind_1}$, so 
from $\normE{\world'}{E[\othercvar]}{\kind}$ we have
$\weakconequiv{\world'}{{\capply{E[\othercvar]}{\constructor_1}}}{{\capply{E[\othercvar]}{\constructor_2}}}
{\substitute{\cvar}{\constructor_1}{\kind_2}}$. %$
By $\semanticvalidtype{\world}{\kind}$, we have 
$\semanticsubtype{\world}{\substitute{\cvar}{\constructor_2}{\kind_2}}{\substitute{\cvar}{\constructor_1}{\kind_2}}$
and so
$\semanticvalidterm{\world'}{\capply{(E[\othercvar])}{\constructor_2}}{\substitute{\cvar}{\constructor_1}{\kind_2}}$.
By IH(\ref{ih-3}) we have
$\semanticequivterm{\world'}{\capply{(E[\othercvar])}{\constructor_1}}{\capply{(E[\othercvar])}{\constructor_2}}
{\substitute{\cvar}{\constructor_1}{\kind_2}}$. %$
\end{itemize}
Therefore, $\semanticvalidterm{\world}{E[\othercvar]}{\kind}$.

\item
First, we must have $\kind'=\kpi{\cvar}{\kind'_1}{\kind'_2}$ with
$\equivkind{\world}{\kind_1}{\kind'_1}$ and $\equivkind{\world,\cvar{:}\kind_1}{\kind_2}{\kind'_2}$.
Let $\world'\supseteq\world$ with $\validcontext{\world'}$ be given, and assume
$\semanticvalidterm{\world'}{\constructor}{\kind_1}$.  Thus 
$\semanticvalidterm{\world'}{\capply{(E[\othercvar])}{\constructor}}
  {\substitute{\cvar}{\constructor}{\kind_2}}$ %$
and
$\semanticvalidterm{\world'}{\capply{(E'[\othercvar])}{\constructor}}
  {\substitute{\cvar}{\constructor}{\kind_2}}$. %$
Clearly $\reconstruct{\world'}{\capply{(E[\othercvar])}{\constructor}}
  {\substitute{\cvar}{\constructor}{\kind_2}}$, %$
$\reconstruct{\world'}{\capply{(E'[\othercvar])}{\constructor}}
  {\substitute{\cvar}{\constructor}{\kind'_2}}$, %$
and $\equivconstructor{\world'}{\capply{(E[\othercvar])}{\constructor}}{\capply{(E'[\othercvar])}{\constructor}}
  {\substitute{\cvar}{\constructor}{\kind_2}}$. %$
By SUBSTITUTION LEMMA, 
$\equivkind{\world'}{\substitute{\cvar}{\constructor}{\kind_2}}{\substitute{\cvar}{\constructor}{\kind'_2}}$.
By IH(\ref{ih-4}) $\normterm{\world'}{\constructor}{\kind_1}$, and therefore
$\weakconequiv{\world'}{\capply{E[\othercvar]}{\constructor}}{\capply{E'[\othercvar]}{\constructor}}
{\substitute{\cvar}{\constructor}{\kind_2}}$. %$
Thus by IH(\ref{ih-3})
$\semanticequivterm{\world'}{(\capply{E}{\constructor})[\othercvar]}{(\capply{E'}{\constructor})[\othercvar]}
{\substitute{\cvar}{\constructor}{\kind_2}}$. %$
Therefore $\semanticequivterm{\world}{E[\othercvar]}{E'[\othercvar]}{\kind}$.
\item Assume
$\semanticvalidterm{\world}{\constructor}{\kpi{\cvar}{\kind_1}{\kind_2}}$.
Since $\semanticvalidtype{\world}{\kind_1}$,
IH(\ref{ih-2}) applies and yields
$\semanticvalidterm{\constructor,\cvar{:}\kind_1}{\cvar}{\kind_1}$.
By MONOTONICITY
$\semanticvalidterm{\world'}{\constructor}{\kind}$, and hence
$\semanticvalidterm{\constructor,\cvar{:}\kind_1}{\capply{\constructor}{\cvar}}{\kind_2}$.
By IH(\ref{ih-4}), $\normterm{\constructor,\cvar{:}\kind_1}{\capply{\constructor}{\cvar}}{\kind_2}$.
Therefore $\normterm{\world}{\constructor}{\kind}$.
\item Assume $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\kpi{\cvar}{\kind_1}{\kind_2}}$.
Again we have 
$\semanticvalidterm{\constructor,\cvar{:}\kind_1}{\cvar}{\kind_1}$.
Then $\semanticequivterm{\world,\cvar{:}\kind_1}{\capply{\constructor_1}{\cvar}}
{\capply{\constructor_2}{\cvar}}{\kind_2}$.  %$
By IH(\ref{ih-5}), 
we have $\aconequiv{\world,\cvar{:}\kind_1}{\capply{\constructor_1}{\cvar}}
{\capply{\constructor_2}{\cvar}}{\kind_2}$.  %$
Therefore, $\aconequiv{\world}{\constructor_1}{\constructor_2}{\kind}$.
\end{enumerate}



\item Case: $\kind=\ksigma{\cvar}{\kind_1}{\kind_2}$.
\begin{enumerate}
\item If $\semanticvalidtype{\world}{\kind}$ then
$\semanticvalidtype{\world}{\kind_1}$, so by IH(\ref{ih-1}) we
have $\normtype{\world}{\kind_1}$.  By IH(\ref{ih-2}) we know
that $\semanticvalidterm{\world,\cvar{:}{\kind_1}}{\cvar}{\kind_1}$
and hence $\semanticvalidtype{\world,\cvar{:}\kind_1}{\kind_2}$.
Again by IH(\ref{ih-1}) we have
$\normtype{\world,\cvar{:}\kind_1}{\kind_2}$.  Therefore 
$\normtype{\world}{\kind}$.

\item First, note that $\semanticvalidtype{\world}{\kind_1}$, 
$\reconstruct{\world}{\cpi{1}{E[\othercvar]}}{\kind_1}$, and 
$\normE{\world}{\cpi{1}{E[\othercvar]}}{\kind_1}$.  Therefore
IH(\ref{ih-2}) applies and
$\semanticvalidterm{\world}{\cpi{1}{E[\othercvar]}}{\kind_1}$.
Thus $\semanticvalidtype{\world}{\substitute{\cvar}{\cpi{1}{E[\othercvar]}}{\kind_2}}$
because$\semanticvalidtype{\world}{\kind}$.
Clearly 
$\reconstruct{\world}{\cpi{2}{E[\othercvar]}}{\substitute{\cvar}{\cpi{1}{E[\othercvar]}}\kind_2}$
and
$\normE{\world}{\cpi{2}{E[\othercvar]}}{\substitute{\cvar}{\cpi{1}{E}}\kind_2}$.
Again by IH(\ref{ih-2}), we have
$\semanticvalidterm{\world}{\cpi{2}{E[\othercvar]}}{\substitute{\cvar}{\cpi{1}{E[\othercvar]}}{\kind_2}}$.
Therefore, $\semanticvalidterm{\world}{E[\othercvar]}{\kind}$.

\item By inversion we must have $\kind'=\ksigma{\cvar}{\kind'_1}{\kind'_2}$ with
$\equivkind{\world}{\kind_1}{\kind'_1}$ and
$\equivkind{\world,\cvar{:}\kind_1}{\kind_2}{\kind'_2}$.
Therefore, it is simple to see that we may apply IH(\ref{ih-3}) to get
$\semanticequivterm{\world}{\cpi{1}{E[\othercvar]}}{\cpi{1}{E'[\othercvar]}}{\kind_1}$,
Thus
$\semanticsubtype{\world}{\substitute{\cvar}{\cpi{1}{E'[\othercvar]}}{\kind_2}}
  {\substitute{\cvar}{\cpi{1}{E[\othercvar]}}{\kind_2}}$ and hence
$\semanticvalidterm{\world}{\cpi{2}{E'[\othercvar]}}{\substitute{\cvar}{\cpi{1}{E[\othercvar]}}{\kind_2}}$.
Again by IH(\ref{ih-3}), we have
$\semanticequivterm{\world}{\cpi{1}{E[\othercvar]}}{\cpi{1}{E'[\othercvar]}}
   {\substitute{\cvar}{\cpi{1}{E[\othercvar]}}{\kind_2}}$.
Therefore, 
Therefore, $\semanticequivterm{\world}{E[\othercvar]}{E'[\othercvar]}{\kind}$.
\item Assume
$\semanticvalidterm{\world}{\constructor}{\ksigma{\cvar}{\kind_1}{\kind_2}}$.
By IH(\ref{ih-4}), $\semanticvalidterm{\world}{\cpi{1}{\constructor}}{\kind_1}$ implies
$\normterm{\world}{\cpi{1}{\constructor}}{\kind_1}$.  Similarly,
$\semanticvalidterm{\world}{\cpi{2}{\constructor}}{\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2}}$ implies
$\normterm{\world}{\cpi{1}{\constructor}}{\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2}}$.
Therefore $\normterm{\world}{\constructor}{\kind}$.
\item Assume $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksigma{\cvar}{\kind_1}{\kind_2}}$.
By IH(\ref{ih-5}), 
$\semanticequivterm{\world}{\cpi{1}{\constructor_1}}{\cpi{2}{\constructor_2}}{\kind_1}$ implies
$\aconequiv{\world}{\cpi{1}{\constructor_1}}{\cpi{1}{\constructor_2}}{\kind_1}$.  Similarly,
$\semanticequivterm{\world}{\cpi{2}{\constructor_1}}{\cpi{2}{\constructor_2}}
    {\substitute{\cvar}{\cpi{1}{\constructor_1}}{\kind_2}}$ implies
$\aconequiv{\world}{\cpi{2}{\constructor_1}}{\cpi{2}{\constructor_2}}
    {\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2}}$.
Therefore, $\aconequiv{\world}{\constructor_1}{\constructor_2}{\kind}$.
\end{enumerate}
\end{itemize}
\end{proof}

\begin{theorem}
\label{thm:weakheadclosure}
\begin{enumerate}
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$ and
$\semanticvalidterm{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\kind}$
then 
$\semanticequivterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
    {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\kind}$
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$ and
$\semanticequivterm{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}
  {E'[\substitute{\cvar}{\constructor_1}{\constructor'}]}{\kind}$
then 
$\semanticequivterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
  {E'[\capply{(\cfunction{\cvar}{\kind_1}{\constructor'})}{\constructor_1}]}{\kind}$
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$, 
$\validconstructor{\world}{\constructor_2}{\kind_2}$, and
$\semanticvalidterm{\world}{E[\constructor_1]}{\kind}$
then 
$\semanticequivterm{\world}{E[\cpi{1}{\cpair{\constructor_1}{\constructor_2}}]}{E[\constructor_1]}{\kind}$.
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$, 
$\validconstructor{\world}{\constructor_2}{\kind_2}$, and
$\semanticequivterm{\world}{E[\constructor_1]}{E'[\constructor_1]}{\kind}$
then 
$\semanticequivterm{\world}{E[\cpi{1}{\cpair{\constructor_1}{\constructor_2}}]}
   {E'[\cpi{1}{\cpair{\constructor_1}{\constructor_2}}]}{\kind}$.
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$, 
$\validconstructor{\world}{\constructor_2}{\kind_2}$, and
$\semanticvalidterm{\world}{E[\constructor_2]}{\kind}$
then 
$\semanticequivterm{\world}{E[\cpi{2}{\cpair{\constructor_1}{\constructor_2}}]}{E[\constructor_2]}{\kind}$.
\item
If $\validconstructor{\world}{\constructor_1}{\kind_1}$, 
$\validconstructor{\world}{\constructor_2}{\kind_2}$, and
$\semanticequivterm{\world}{E[\constructor_2]}{E'[\constructor_2]}{\kind}$
then 
$\semanticequivterm{\world}{E[\cpi{2}{\cpair{\constructor_1}{\constructor_2}}]}
   {E'[\cpi{2}{\cpair{\constructor_1}{\constructor_2}}]}{\kind}$.
\end{enumerate}
\end{theorem}

\begin{proof}
By induction on $\kind$.  Note that by symmetry and transitivity, (2),
(4), and (6) are trivial corollaries of (1), (3), and (5)
respectively.  Further, the proofs for (1), (3), and (5) are identical
except for the particular reduction step involved, so we prove only the first.

\begin{enumerate}
\item
Assume $\validconstructor{\world}{\constructor_1}{\kind_1}$ and
$\semanticvalidterm{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\kind}$.
By LEMMA, 
$\validconstructor{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}{\ktype}$.

\newcommand{\redex}{\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}}
\newcommand{\reduct}{\substitute{\cvar}{\constructor_1}{\constructor}}

\begin{itemize}
\item Case: $\kind = \ktype$.  

By Theorem~\ref{maintheorem}, we have
$\normterm{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$.
Thus $\headnormsto{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}{\cvalue}$
and $\normterm{\world}{\cvalue}{\ktype}$.
But clearly 
$\headnormsto{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}{\ktype}{\cvalue}$
as well.  Hence
$\normterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}{\ktype}$,
$\semanticvalidterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}{\ktype}$,
$\aconequiv{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$, and
$\equivconstructor{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$, and
Therefore
$\semanticequivterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$.

\item Case: $\kind=\ksingleton{\otherconstructor}$.

First, 
$\semanticvalidterm{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\kind}$
implies
$\aconequiv{\world}{E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\otherconstructor}{\ktype}$.
Exactly as in the previous case,
$\normterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}{\ktype}$,
$\aconequiv{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$,
$\equivconstructor{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ktype}$.
By transitivity,
$\aconequiv{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {\otherconstructor}{\ktype}$.
Therefore,
$\semanticequivterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\ksingleton{\otherconstructor}}$.

\item Case: $\ktype = \kpi{\cvar}{\kind'}{\kind''}$.

Let $\world'\supseteq\world$ be a valid context.
\begin{enumerate}
\item 
Assume $\semanticvalidterm{\world'}{\constructor'}{\kind'}$. Then 
$\semanticvalidterm{\world}{\capply{(E[\reduct])}{\constructor'}}{\substitute{\cvar}{\constructor'}\kind''}$.
By IH,
$\semanticequivterm{\world}{\capply{(E[\redex])}{\constructor'}}{\capply{(E[\reduct])}{\constructor'}}
    {\substitute{\cvar}{\constructor'}\kind''}$.
Thus
$\semanticvalidterm{\world}{\capply{(E[\redex])}{\constructor'}}{\substitute{\cvar}{\constructor'}\kind''}$.
\item Assume $\semanticequivterm{\world'}{\constructor'}{\constructor''}{\kind'}$.
Then
$\semanticequivterm{\world}{\capply{(E[\reduct])}{\constructor'}}
   {\capply{(E[\reduct])}{\constructor''}}{\substitute{\cvar}{\constructor'}\kind''}$.
By IH, 
$\semanticequivterm{\world}{\capply{(E[\redex])}{\constructor'}}
   {\capply{(E[\redex])}{\constructor''}}{\substitute{\cvar}{\constructor'}\kind''}$.
\end{enumerate}
Therefore 
$\semanticvalidterm{\world}{E[\redex]}{\kpi{\cvar}{\kind'}{\kind''}}$.

The further argument that 
$\semanticequivterm{\world}{E[\capply{(\cfunction{\cvar}{\kind_1}{\constructor})}{\constructor_1}]}
   {E[\substitute{\cvar}{\constructor_1}{\constructor}]}{\kpi{\cvar}{\kind'}{\kind''}}$ is
contained within this proof.

\item Case: $\kind=\ksigma{\cvar}{\kind'}{\kind''}$.

First, $\semanticvalidterm{\world}{\cpi{1}{E[\reduct]}}{\kind'}$ and
$\semanticvalidterm{\world}{\cpi{2}{E[\reduct]}}{\substitute{\cvar}{\cpi{1}{E[\reduct]}}{\kind'}}$.
By IH,
$\semanticequivterm{\world}{\cpi{1}{E[\redex]}}{\cpi{1}{E[\reduct]}}{\kind'}$ and
$\semanticequivterm{\world}{\cpi{2}{E[\redex]}}{\cpi{2}{E[\reduct]}}
    {\substitute{\cvar}{\cpi{1}{E[\reduct]}}{\kind'}}$.

Therefore, 
$\semanticequivterm{\world}{E[\redex]}{E[\reduct]}{\ksigma{\cvar}{\kind'}{\kind''}}$

\end{itemize}
\end{enumerate}
\end{proof}

\newcommand{\envone}{\hat{\env_1}}
\newcommand{\envtwo}{\hat{\env_2}}
\newcommand{\envonex}{\widehat{\env_1[\cvar{\mapsto}\cvar]}}
\newcommand{\envtwox}{\widehat{\env_2[\cvar{\mapsto}\cvar]}}

\begin{theorem}
Assume that $\validcontext{\world}$ and that
$\forall\cvar\in\dom\context.\ \semanticequivterm{\world}{\envone\cvar}{\envtwo\cvar}{\envone(\context\cvar)}$.
\begin{enumerate}
\item If $\validkind{\context}{\kind}$ then $\semanticsubtype{\world}{\envone\kind}{\envtwo\kind}$.
\item If $\subkind{\context}{\kind_1}{\kind_2}$ then
$\semanticsubtype{\world}{\envone\kind_1}{\envone\kind_2}$.
\item If $\validconstructor{\context}{\constructor}{\kind}$ then
$\semanticequivterm{\world}{\envone\constructor}{\envtwo{\kind}}{\envone\kind}$.
\item If $\equivconstructor{\context}{\constructor_1}{\constructor_2}{\kind}$
then $\semanticequivterm{\world}{\envone\constructor_1}{\envone\constructor_2}{\envone\kind}$.
\end{enumerate}
\end{theorem}


\begin{proof}
\begin{itemize}
\item Rule~\ref{wfk:ktype}.  Follows from $\semanticequivtype{\world}{\ktype}{\ktype}$.

\item Rule~\ref{wfk:ksingleton}.  By IH, 
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}{\ktype}$, so
$\subkind{\world}{\ksingleton{\envone\constructor}}{\ksingleton{\envtwo\constructor}}$.

Assume $\semanticvalidterm{\world}{\constructor_1}{\ksingleton{\envone\constructor}}$.  Then
$\validconstructor{\world}{\constructor_1}{\ksingleton{\envtwo\constructor}}$,
$\aconequiv{\world}{\constructor_1}{\envone\constructor}{\ktype}$,
and $\normterm{\world}{\constructor_1}{\ktype}$.
By TRANSITIVITY $\aconequiv{\world}{\constructor_1}{\envtwo\constructor}{\ktype}$, and
so $\semanticvalidterm{\world}{\constructor_1}{\ksingleton{\envtwo\constructor}}$.

Assume $\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksingleton{\envone\constructor}}$.
then $\semanticvalidterm{\world}{\constructor_1}{\ksingleton{\envtwo\constructor}}$ and
$\semanticvalidterm{\world}{\constructor_2}{\ksingleton{\envtwo\constructor}}$ so
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksingleton{\envtwo\constructor}}$.

Therefore $\semanticsubtype{\world}{\ksingleton{\envone\constructor}}{\ksingleton{\envtwo\constructor}}$.

%\item Rules~\ref{wfk:kpi} or \ref{wfk:ksigma}.  Without loss we may
%assume 
%$\cvar\not\in\dom\world$.  
%By IH, $\semanticvalidtype{\world}{\hat\env\kind_1}$, and so $\validkind{\world}{\hat\env\kind_1}$.
%Let the valid context $\world'\supseteq\world$ be given, and assume that
%$\semanticvalidterm{\world'}{\constructor}{\hat\env\kind_1}$.
%Let $\env'$ be the extension of $\env$ which maps $\cvar$ to $\constructor$.
%By monotonicity results, the IH applies, and 
%$\semanticvalidtype{\world,\cvar{:}\hat\env\kind_1}{\hat{\env'}\kind_2}$.
%From $\cvar\not\in\dom\world$ we have that 
%$\hat{\env'}\kind_2 = \substitute{\cvar}{\constructor}{(\hat\env\kind_2)}$, 
%and the desired conclusion follows.

\item Rule~\ref{wfc:basetype}.
It is clear from the definition that 
$\semanticequivterm{\world}{\basetype}{\basetype}{\ktype}$.
\item Rule~\ref{wfc:cvar}.
By assumption,
$\semanticequivterm{\world}{\hat{\env_1}\cvar}{\hat{\env_2}\cvar}{\hat{\env_1}(\context\cvar)}$.
\item Rule~\ref{wfc:capply}.
By IH we have
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
  {\kpi{\cvar}{\envone{\kind_1}}{\envonex{\kind_2}}}$ and
$\semanticequivterm{\world}{\envone\constructor_1}{\envtwo\constructor_1}{\envone\kind_1}$.
Thus
$\semanticequivterm{\world}{\capply{(\envone\constructor)}{(\envone{\constructor_1})}}
   {\capply{(\envtwo\constructor)}{(\envone{\constructor_1})}}
   {\envone(\substitute{\cvar}{\constructor_1}{\kind_2})}$.
Further, since 
$\semanticvalidterm{\world}{\envtwo\constructor}{\kpi{\cvar}{\envone{\kind_1}}{\envonex{\kind_2}}}$,
we have
$\semanticequivterm{\world}{\capply{(\envtwo\constructor)}{(\envone{\constructor_1})}}
   {\capply{(\envtwo\constructor)}{(\envtwo{\constructor_1})}}
   {\envone(\substitute{\cvar}{\constructor_1}{\kind_2})}$.
By symmetry and transivity,
$\semanticequivterm{\world}{\capply{(\envone\constructor)}{(\envone{\constructor_1})}}
   {\capply{(\envtwo\constructor)}{(\envtwo{\constructor_1})}}
   {\envone(\substitute{\cvar}{\constructor_1}{\kind_2})}$.
\item Rule~\ref{wfc:cpione}.
By IH we have
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
    {\ksigma{\cvar}{\envone{\kind_1}}{\envonex{\kind_2}}}$.
Therefore, 
$\semanticequivterm{\world}{\cpi{1}{(\envone\constructor)}}{\cpi{1}{(\envtwo\constructor)}}{\envone\kind_1}$.
\item Rule~\ref{wfc:cpitwo}.
By IH we have
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
    {\ksigma{\cvar}{\envone{\kind_1}}{\envonex{\kind_2}}}$.
Therefore, 
$\semanticequivterm{\world}{\cpi{2}{(\envone\constructor)}}{\cpi{2}{(\envtwo\constructor)}}
   {\substitute{\cvar}{\envone(\cpi{1}{\constructor})}{(\envonex{\kind_2})}}$, or equivalently
$\semanticequivterm{\world}{\envone(\cpi{2}{\constructor})}{\envtwo(\cpi{2}{\constructor})}
   {\envone(\substitute{\cvar}{\cpi{1}{\constructor}}{\kind_2})}$.
\item Rule~\ref{wfc:cpair}.
By IH we have
$\semanticequivterm{\world}{\envone\constructor_1}{\envtwo\constructor_1}{\envone\kind_1}$
and $\envone\constructor_2$ is well-formed.
By Theorem~\ref{thm:weakheadclosure}, we have
$\semanticequivterm{\world}{\envone(\cpi{1}{\cpair{\constructor_1}{\constructor_2}})}
   {\envtwo(\cpi{1}{\cpair{\constructor_1}{\constructor_2}})}{\envone\kind_1}$.
Again by IH we have
$\semanticequivterm{\world}{\envone\constructor_2}{\envtwo\constructor_2}
   {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$.
Again by Theorem~\ref{thm:weakheadclosure},
$\semanticequivterm{\world}{\envone(\cpi{1}{\cpair{\constructor_1}{\constructor_2}})}
   {\envone\constructor_1}{\envone\kind_1}$.
Thus, we may apply the IH to get
$\semanticsubtype{\world}{\widehat{\envone[\cvar{\mapsto}\envone\constructor_1]}\kind_2}
    {\widehat{\envone[\cvar{\mapsto}\envone(\cpi{1}{\cpair{\constructor_1}{\constructor_2}})]}\kind_2}$.
Applying Theorem~\ref{thm:weakheadclosure} one last time, we have
$\semanticequivterm{\world}{\envone(\cpi{2}{\cpair{\constructor_1}{\constructor_2}})}
   {\envtwo(\cpi{2}{\cpair{\constructor_1}{\constructor_2}})}
   {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$.
Therefore,
$\semanticequivterm{\world}{\envone\constructor_2}{\envtwo\constructor_2}
  {\substitute{\cvar}{\envone(\cpi{1}{\cpair{\constructor_1}{\constructor_2}})}{(\envonex\kind_2)}}$.

\item Rule~\ref{wfc:forgetsingleton}.
By IH, $\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}{\ktype}$.
Thus $\normterm{\world}{\envone\constructor}{\ktype}$, 
$\validconstructor{\world}{\envone\constructor}{\ktype}$, 
$\validkind{\world}{\envone\constructor}$, and
$\validconstructor{\world}{\envone\constructor}{\ksingleton{\envone\constructor}}$,
and so
$\semanticvalidterm{\world}{\envone\constructor}{\ksingleton{\envone\constructor}}$.

Furthermore, we have $\normterm{\world}{\envtwo\constructor}{\ktype}$,
$\aconequiv{\world}{\envone\constructor}{\envtwo\constructor}{\ktype}$,
$\equivconstructor{\world}{\envone\constructor}{\envtwo\constructor}{\ktype}$,
$\equivkind{\world}{\ksingleton{\envone\constructor}}{\ksingleton{\envtwo\constructor}}$, and
$\validconstructor{\world}{\envtwo\constructor}{\ksingleton{\envone\constructor}}$.
Therefore $\semanticvalidterm{\world}{\envtwo\constructor}{\ksingleton{\envone\constructor}}$ and
so $\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}{\ksingleton{\envone\constructor}}$.

\item Rule~\ref{wfc:selfsigmaone}.
By IH
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
   {\ksigma{\cvar}{(\envone\kind_1)}{(\envonex{\kind_2})}}$ and
$\semanticequivterm{\world}{\envone{\cpi{1}{\constructor}}}{\envtwo{\cpi{1}{\constructor}}}
   {\envone\kind'_1}$.
Thus 
$\semanticequivterm{\world}{\cpi{2}{\envone\constructor}}{\cpi{2}{\envtwo\constructor}}
   {\substitute{\cvar}{\cpi{1}{\envone\constructor}}{\kind_2}}$.
Therefore
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
   {\ksigma{\cvar}{(\envone\kind'_1)}{(\envonex{\kind_2})}}$ and

\item Rule~\ref{wfc:selfsigmatwo}.
By IH,$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
   {\ksigma{\cvar}{(\envone\kind_1)}{(\envonex{\kind_2})}}$, and so
$\semanticequivterm{\world}{\cpi{1}{\envone\constructor}}{\cpi{1}{\envtwo\constructor}}
   {\envone\kind_1}$.
Again by IH, 
$\semanticequivterm{\world}{\envone{\cpi{2}{\constructor}}}{\envtwo{\cpi{2}{\constructor}}}
   {\envone{\substitute{\cvar}{\cpi{1}{\constructor}}{\kind'_2}}}$.
Therefore
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
   {\ksigma{\cvar}{(\envone\kind_1)}{(\envonex{\kind'_2})}}$.

\item Rule~\ref{wfc:selfpi}.
Assume $\world'\supseteq\world$ is well-formed, and let
$\semanticvalidterm{\world'}{\constructor_1}{\envone\kind_1}$.
By IH,
$\semanticequivterm{\world}{\widehat{\envone[\cvar{\mapsto}\constructor_1]}(\capply{\constructor}{\cvar})}
   {\widehat{\envtwo[\cvar{\mapsto}\constructor_1]}(\capply{\constructor}{\cvar})}
   {\widehat{\envone[\cvar{\mapsto}\constructor_1]}\kind'_2}$.
That is,
$\semanticequivterm{\world}{\capply{(\envone\constructor)}\constructor_1}
   {\capply{(\envtwo\constructor)}\constructor_1}
   {\widehat{[\cvar{\mapsto}\constructor_1]}(\envonex\kind'_2)}$.
Therefore,
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}
   {\kpi{\cvar}{\envone\kind_1}{(\envonex\kind'_2)}}$.

\item Rule~\ref{wfc:subsume}
By IH we have
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}{\envone\kind}$
and
$\semanticsubtype{\world}{\envone\kind}{\envone\kind'}$.
Therefore,
$\semanticequivterm{\world}{\envone\constructor}{\envtwo\constructor}{\envone\kind'}$.

\item Rule~\ref{ce:reflexive}
By IH we have
$\semanticequivterm{\world}{\envone\constructor}{\envone\constructor}{\envone{\kind}}$,
and this is exactly what we are trying to show.

\item Rule~\ref{ce:symmetric}
By SYMMETRY of semantic equivalence.

\item Rule~\ref{ce:transitive}
By TRANSITIVITY of semantic equivalence.

\item Rule~\ref{ce:singleton}
By IH we have
$\semanticvalidterm{\world}{\envone\constructor}{\ksingleton{\envone\constructor'}}$.
Thus
$\semanticvalidterm{\world}{\envone\constructor}{\ktype}$,
$\semanticvalidterm{\world}{\envone\constructor'}{\ktype}$,
$\equivconstructor{\world}{\envone\constructor}{\envone\constructor'}{\ktype}$, and
$\aconequiv{\world}{\envone\constructor}{\envone\constructor'}{\ktype}$.
Therefore
$\semanticequivterm{\world}{\envone\constructor}{\envone\constructor'}{\ktype}$.

\item Rule~\ref{ce:cfunction}
Let the valid world $\world'\supseteq\world$ and 
$\semanticvalidterm{\world'}{\constructor_1}{\envone\kind_1}$ be given.
By IH, 
$\semanticequivterm{\world'}{\substitute{\cvar}{\constructor_1}{(\envonex\constructor)}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\constructor')}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$.
By Theorem~\ref{thm:weakheadclosure}, we have
$\semanticequivterm{\world'}{\capply{(\cfunction{\cvar}{\envone\kind_1}{\constructor})}{\constructor_1}}
    {\capply{(\cfunction{\cvar}{\envone\kind_1}{\constructor'})}{\constructor_1}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$.
Therefore,
$\semanticequivterm{\world}{\cfunction{\cvar}{\envone\kind_1}{\constructor}}
    {\cfunction{\cvar}{\envone\kind_1}{\constructor'}}
    {\kpi{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:cpione}
By IH,
$\semanticequivterm{\world}{\envone\constructor}{\envone\constructor'}
    {\ksigma{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$.
Therefore,
$\semanticequivterm{\world}{\cpi{1}{\envone\constructor}}{\cpi{1}{\envone\constructor'}}{\envone\kind_1}$.

\item Rule~\ref{ce:cpitwo}
By IH,
$\semanticequivterm{\world}{\envone\constructor}{\envone\constructor'}
    {\ksigma{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$.
Therefore,
$\semanticequivterm{\world}{\cpi{2}{\envone\constructor}}{\cpi{2}{\envone\constructor'}}
    {\substitute{\cvar}{\cpi{1}{\envone\constructor}}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:cpair}.
By IH,
$\semanticequivterm{\world}{\envone\constructor_1}{\envone\constructor'_1}{\envone\kind_1}$
and
$\semanticequivterm{\world}{\envone\constructor_2}{\envone\constructor'_2}
   {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$.
By Theorem~\ref{thm:weakheadclosure},
$\semanticequivterm{\world}{\envone\cpi{1}{\cpair{\constructor_1}{\constructor_2}}}
     {\envone\cpi{1}{\cpair{\constructor'_1}{\constructor'_2}}}{\envone\kind_1}$,
$\semanticequivterm{\world}{\envone\cpi{2}{\cpair{\constructor_1}{\constructor_2}}}
     {\envone\cpi{2}{\cpair{\constructor'_1}{\constructor'_2}}}
     {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$, and
$\semanticequivterm{\world}{\envone\constructor_1}{\envone\cpi{1}{\cpair{\constructor_1}{\constructor_2}}}
    {\envone\kind_1}$.
Thus by IH again (careful!)
$\semanticsubtype{\world}
   {\envone[\cvar{\mapsto}\envone\cpi{1}{\cpair{\constructor_1}{\constructor_2}}]\kind_2}
   {\envone[\cvar{\mapsto}\envone\constructor_1]\kind_2}$
Thus 
$\semanticequivterm{\world}{\envone\cpi{2}{\cpair{\constructor_1}{\constructor_2}}}
     {\envone\cpi{2}{\cpair{\constructor'_1}{\constructor'_2}}}
     {\substitute{\cvar}{\envone\cpi{1}{\cpair{\constructor_1}{\constructor_2}}{(\envonex\kind_2)}}}$,
and so
$\semanticequivterm{\world}
     {\envone\cpair{\constructor_1}{\constructor_2}}
     {\envone\cpair{\constructor'_1}{\constructor'_2}}
     {\ksigma{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:capply}.
By IH, 
$\semanticequivterm{\world}{\envone\constructor}{\envone\constructor'}
    {\kpi{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$ and
$\semanticequivterm{\world}{\envone\constructor_1}{\envone\constructor'_1}{\envone\kind_1}$.
Thus
$\semanticequivterm{\world}{\capply{(\envone\constructor)}{(\envone\constructor_1)}}
    {\capply{(\envone\constructor')}{(\envone\constructor_1)}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$ and
$\semanticequivterm{\world}{\capply{(\envone\constructor')}{(\envone\constructor_1)}}
    {\capply{(\envone\constructor')}{(\envone\constructor'_1)}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$.
By TRANSITIVITY,
$\semanticequivterm{\world}{\capply{(\envone\constructor)}{(\envone\constructor_1)}}
    {\capply{(\envone\constructor')}{(\envone\constructor'_1)}}
    {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:cfunctioneta}.
Let the well-formed $\world'\supseteq\world$ and
$\semanticvalidterm{\world'}{\constructor_1}{\envone\kind_1}$ be given.
By IH and this assumption,
$\semanticvalidterm{\world'}{\capply{\envone\constructor}{\constructor_1}}
    {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$.
But
$\capply{\envone\constructor}{\constructor_1} = 
    \substitute{\cvar}{\constructor_1}{(\capply{\envone\constructor}{\cvar})}$,
so by Theorem~\ref{thm:weakheadclosure} we have
$\semanticequivterm{\world'}
   {\capply{(\cfunction{\cvar}{\envone\kind_1}{\capply{\envone\constructor}{\cvar}})}{\constructor_1}}
   {\capply{\envone\constructor}{\constructor_1}}
   {\substitute{\cvar}{\constructor_1}{(\envonex\kind_2)}}$.
Therefore
$\semanticequivterm{\world}{\cfunction{\cvar}{\envone\kind_1}{\capply{\envone\constructor}{\cvar}}}
   {\envone\constructor}
   {\kpi{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:cfunctionbeta}.
By IH,
$\semanticvalidterm{\world}{\envone\constructor_1}{\envone\kind_1}$.
Thus again by IH we have
$\semanticvalidterm{\world}{\widehat{\env_1[\cvar{\mapsto}{\envone\constructor_1}]}\constructor}
   {\widehat{\env_1[\cvar{\mapsto}{\envone\constructor_1}]}\kind_2}$.
By Theorem~\ref{thm:weakheadclosure} we have
$\semanticequivterm{\world}
   {\capply{(\cfunction{\cvar}{\envone\kind_1}{(\envonex\constructor)})}{\constructor_1}}
   {\substitute{\cvar}{\envone\constructor_1}(\envonex\constructor)}
   {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$.

\item Rule~\ref{ce:cpionebeta}.
By IH,
$\semanticvalidterm{\world}{\cpair{\envone\constructor_1}{\envone\constructor_2}}
   {\ksigma{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$. 
By Theorem~\ref{thm:weakheadclosure} we have
$\semanticequivterm{\world}
  {\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}
  {\envone\constructor_1}
  {\envone\kind_1}$.

\item Rule~\ref{ce:cpitwobeta}.
By IH,
$\semanticvalidterm{\world}{\cpair{\envone\constructor_1}{\envone\constructor_2}}
   {\ksigma{\cvar}{\envone\kind_1}{(\envonex\kind_2)}}$. 
Thus
$\semanticvalidterm{\world}{\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}
   {\envone\kind_1}$ and
$\semanticvalidterm{\world}{\cpi{2}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}
   {\substitute{\cvar}{\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}{(\envonex\kind_2)}}$.
By Theorem~\ref{thm:weakheadclosure} we have
$\semanticequivterm{\world}
  {\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}
  {\envone\constructor_1}
  {\envone\kind_1}$ 
and
$\semanticequivterm{\world}
  {\cpi{2}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}
  {\envone\constructor_2}
   {\substitute{\cvar}{\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}{(\envonex\kind_2)}}$.
As in other cases, from the IH (careful!) we get
$\semanticsubtype{\world}
   {\substitute{\cvar}{\cpi{1}{\cpair{\envone\constructor_1}{\envone\constructor_2}}}{(\envonex\kind_2)}}
   {\substitute{\cvar}{\envone\constructor_1}{(\envonex\kind_2)}}$,
and the desired conclusion follows.

\item Rule~\ref{ce:cpaireta}.
$\ldots$

\item Rule~\ref{ce:subsume}.
By IH we have
$\semanticequivterm{\world}{\envone\constructor_1}{\envone\constructor_2}{\envone\kind}$
and
$\semanticsubtype{\world}{\envone\kind}{\envone\kind'}$.
Therefore,
$\semanticequivterm{\world}{\envone\constructor_1}{\envone\constructor_2}{\envone\kind'}$

\end{itemize} 
\end{proof}


\iffalse

\item Rule~\ref{sk:ktype}.  Follows from
$\semanticvalidtype{\world}{\ktype}$.
The remaining conditions to be checked are tautologies.

\item Rule~\ref{sk:ksingleton}.  By IH,
$\semanticequivtype{\world}{\hat\env\constructor_1}{\hat\env\constructor_2}{\ktype}$
and so 
$\conequiv{\world}{\hat\env\constructor_1}{\hat\env\constructor_2}{\ktype}$.
If
$\semanticvalidterm{\world}{\constructor}{\ksingleton{\hat\env\constructor_1}}$
then
$\normterm{\world}{\constructor}{\ktype}$,
$\conequiv{\world}{\constructor}{\hat\env\constructor_1}{\ktype}$;
by a TRANSITIVITY LEMMA we have
$\conequiv{\world}{\constructor}{\hat\env\constructor_2}{\ktype}$
which gives us
$\semanticvalidterm{\world}{\constructor}{\ksingleton{\hat\env\constructor_1}}$.
Similarly, if
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksingleton{\hat\env\constructor_1}}$
then 
$\conequiv{\world}{\constructor_1}{\constructor_2}{\ktype}$ and hence
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksingleton{\hat\env\constructor_2}}$.

$\semanticsubtype{\world}{\hat\env\kind_1}{\hat\env\kind_2}$ and
$\semanticsubtype{\world}{\hat\env\kind_2}{\hat\env\kind_3}$.  The
desired conclusion obviously follows.

\item Rule~\ref{sk:forget}.  By IH,
$\semanticvalidtype{\world}{\hat\env\ksingleton{\constructor}}$ and
hence $\validkind{\world}{\hat\env\ksingleton{\constructor}}$.
$\semanticvalidtype{\world}{\ktype}$ by definition, and 
by Rule~\ref{sk:forget} we have
$\subkind{\world}{\hat\env\ksingleton{\constructor}}{\ktype}$.
If
$\semanticvalidterm{\world}{\constructor}{\ksingleton{\hat\env\constructor}}$
then clearly
$\semanticvalidterm{\world}{\constructor}{\ktype}$.
Similarly,
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ksingleton{\hat\env\constructor}}$
if and only if
$\semanticequivterm{\world}{\constructor_1}{\constructor_2}{\ktype}$.

\item etc.
\fi


\begin{theorem}
\begin{enumerate}
\item If $\equivcontext{\context_1}{\context_2}$,
$\normterm{\context_1}{\constructor_1}{\kind_1}$,
$\normterm{\context_2}{\constructor_2}{\kind_2}$, and
$\equivkind{\context_1}{\kind_1}{\kind_2}$,
then 
$\aconequiv{\context}{\constructor}{\constructor_2}{\kind_1}$
is decidable.
\item If $\equivcontext{\context_1}{\context_2}$,
$\normE{\context_1}{\constructor_1}{\kind_1}$, and
$\normE{\context_2}{\constructor_2}{\kind_2}$, then
$\weakconequiv{\context}{\constructor}{\constructor_2}{\kind_1}$
is decidable.
\end{enumerate}
\end{theorem}

\begin{proof}
By induction on the proof that $\normterm{\context_1}{\constructor_1}{\kind_1}$
or $\normE{\context_1}{\constructor_1}{\kind_1}$ respectively.  Note
that for there to be any chance for the algorithmic equivalence to hold,
the corresponding proofs for $\normterm{\context_2}{\constructor_2}{\kind_2}$
and $\normE{\context_2}{\constructor_2}{\kind_2}$ must use the same final step.
\end{proof}

%\bibliographystyle{plain}
%\bibliography{bib}

\end{document}
